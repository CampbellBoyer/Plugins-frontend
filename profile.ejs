<!DOCTYPE html>
<html>
<head>
  <title>Profile</title>
  <%- include('header'); %>
</head>
<body>
  <%- include('top-navigation'); %>

<!--------------------------->
<!-- Profile Info Section -->
<!--------------------------->
<div id="app">

<% if (user.id === profileUser.id) { %>
<a class="uk-button button-lt uk-margin-small uk-margin-right uk-margin-left uk-float-right" v-on:click="signOut"><span uk-icon="sign-out"></span> &nbsp;Sign Out</a>
<% } %>

<div class="uk-container"></div>
<div class="uk-card uk-card-default uk-margin uk-margin-right uk-margin-left">
  <div class="uk-card-header container-top">
    <div class="uk-grid-small uk-flex-middle" uk-grid>
      <h4 class="norwester font-white">Profile Information &nbsp;
        <% if (user.id === profileUser.id) { %>
        <a class="font-white" href="/profile-top-editor">(Edit)</a>
        <% } else if (user.hasPermission('admin') || user.hasPermission('edit_profiles')) { %>
        <a class="font-white" href="<%= '/admin-edit-profile/' + profileUser.id %>">(Edit)</a>
        <% } %>
      </h4>
    </div>
  </div>
  <div class="uk-card-body white">
    <div class="uk-grid-match uk-child-width-1-3@m uk-flex-top" uk-grid>
      <div>
        <div class="uk-width-auto">
          <img id="profile-photo" class="uk-border-rounded uk-height-small uk-width-auto" 
            src="<%= profileUser.profilePhotoRef ? '/api/photo/' + profileUser.profilePhotoRef : '/profile_photo_placeholder.svg' %>" alt="Profile Photo">
        </div>
        <% if (user.id === profileUser.id) { %>
        <a href="#pw-modal" uk-toggle><span uk-icon="icon: lock"></span>&nbsp;Change Password</a>
        <% } %>
        <br><br>
        <span class="uk-margin-small-top profile-label">Name</span>
        <span id="name" class="profile-field"><%= [profileUser.first_name, profileUser.middle_name, profileUser.last_name].filter(function(e) { return !!e; }).join(' ') || '--' %></span>
        <span class="profile-label">Graduated</span>
        <span id="grad_year" class="profile-field"><%= profileUser.graduation_year || '--' %></span>
        <% if (profileUser.isDeceased) { %><span class="profile-label">Deceased</span><% } %>
      </div>

      <div>
        <span class="profile-label">Nicknames</span>
        <span id="nickname" class="profile-field"><%= profileUser.nicknames || '--' %></span>
        <span class="profile-label">Email</span>
        <span id="email" class="profile-field"><%= profileUser.email || '--' %></span>
        <span class="profile-label">Home Phone</span>
        <span id="home_phone" class="profile-field"><%= profileUser.home_phone || '--' %></span>
        <span class="profile-label">Cell Phone</span>
        <span id="mobile_phone" class="profile-field"><%= profileUser.cell_phone || '--' %></span>
        <span class="profile-label">Birthday</span>
        <span id="birthday" class="profile-field"><%= profileUser.birthday || '--' %></span>
      </div>

      <div>
        <span class="profile-label">Marital Status</span>
        <span id="marital_status" class="profile-field"><%= profileUser.marital_status || '--' %></span>
        <span class="profile-label">Address</span>
        <span>
          <span id="address_line1" class="profile-field"><%= profileUser.address_line_1 || '--' %></span><br>
          <span id="address_line2" class="profile-field"><%= profileUser.address_line_2 || '--' %></span><br>
          <span id="city" class="profile-field"><%= [profileUser.city, profileUser.state, profileUser.zip_code].filter(e => e).join(', ') || '--' %></span>
        </span>
        <span class="profile-label uk-margin">Privacy &nbsp;<span uk-icon="info" uk-tooltip="All alumni can view your yearbook photo, name and graduation year.  If you set your profile as public,  paid members can also view your phone number, address, email, birthday, and marital status.  To hide this information set your profile as private."></span></span>
        <% if (profileUser.isPublic) { %> 
          <span><i class="fa fa-toggle-on font-slate"></i><p>&nbsp;Profile is Public</p></span>
        <% } else { %> 
          <span><i class="fa fa-toggle-off font-slate"></i><p>&nbsp;Profile is Private</p></span>
        <% } %>
      </div>
    </div>
  </div>
</div>


<!--------------------------->
<!-- Group Listing Section -->
<!--------------------------->
<div class="uk-margin-medium-top uk-margin-right uk-margin-left">
  <% if (user.id === profileUser.id) { %>
  <div class="uk-grid-match uk-child-width-1-3@m" uk-grid>
  <% } else { %>
  <div class="uk-grid-match uk-child-width-1-2@m" uk-grid>
  <% } %>
    <div>
      <div class="uk-card uk-card-default">
        <div class="uk-card-header container-top">
          <h4 class="norwester font-white">Groups</h4>
        </div>
        <div class="uk-card-body white">
          <div class="uk-child-width-1-1@m">
          <% profileUser.groups.forEach(function(group) { %>
            <div class="uk-margin-small-top"><a href="<%- '/group-details/' + group.id %>"><%= group.group_name %></a></div>
          <% }); %>
          <% if (user.id === profileUser.id && profileUser.groups.length == 0) { %>
            <i>You are not currently a member of any group.</i>
          <% } else if (profileUser.groups.length == 0) { %>
            <i><%= [profileUser.first_name, profileUser.middle_name, profileUser.last_name].filter(function(e) { return !!e; }).join(' ') %> is not currently a member of any group.</i>
          <% } %>
          </div>
        </div>
      </div>
    </div>

    <div>
      <div class="uk-card uk-card-default white">
        <div class="uk-card-header container-top">
          <h4 class="norwester font-white">Activities <% if (user.id === profileUser.id) { %><a class="font-white" href="#activities-modal" uk-toggle>&nbsp;&nbsp;(Edit)</a><% } %></h4>
        </div>
        <div>
          <% if (profileUser.activities.length > 0) { %>
          <div class="uk-margin-medium-top"></div>
          <% } %>
          <% profileUser.activities.forEach(function(activity) { %>
          <div class="uk-margin-medium-left uk-margin-small-top"><%= activity.name %></div>
          <% }); %>
          <div class="uk-padding">
          <% if (user.id === profileUser.id && profileUser.activities.length == 0) { %>
            <i>You do not currently have any listed activities.</i>
          <% } else if (profileUser.activities.length == 0) { %>
            <i><%= [profileUser.first_name, profileUser.middle_name, profileUser.last_name].filter(function(e) { return !!e; }).join(' ') %> does not have any listed activities.</i>
          <% } %>
          </div>
        </div>
      </div>
    </div>

    <!--------------------------->
    <!-- Membership Section -->
    <!--------------------------->
    <% if (user.id === profileUser.id) { %>
    <div>
      <div class="uk-card uk-card-default">
        <div class="uk-card-header container-top">
          <h4 class="norwester font-white">Membership</h4>
        </div>
        <div class="uk-card-body white">
          <span class="profile-label uk-float-left">Type</span> <a class="uk-float-right" href="/membership-types">View Benefits &nbsp;<i class="fa fa-external-link"></i></a>
          <br>
          <span id="nickname" class="profile-field">
            <span uk-icon="check"></span> &nbsp;<%= profileUser.membership.membershipType.name %>
          </span>
            <a href="/membership-types">&nbsp;(Edit)</a>
            <br><br>
          <% if (profileUser.membership && profileUser.membership.membership_type !== 1) { %>
          <span class="profile-label">Payment Method</span><br>
          <span id="pay_method" class="profile-field"><a href="https://www.paypal.com/us/signin" target="_blank">PayPal</a></span>
          <% } %>
          <% if (profileUser.membership && profileUser.membership.membershipType.name === 2) { %> 
          <span class="profile-label">Renewal Scheduled On</span><br>
          <span id="renews_on" class="profile-field"><%= profileUser.membership.renewal_date %></span><br><br>
          <span class="profile-label">Auto-Renew?</span><br>
          <span id="auto-renew" class="profile-field"><%= profileUser.membership.auto_renew_membership ? 'Yes' : 'No' %></span> <a href="/membership-types">&nbsp;(Edit)</a>
          <% } %>
        </div>
      </div>
    </div>
    <% } %>

</div>
</div>


<!--------------------------->
<!-- Event Section -->
<!--------------------------->
<div class="uk-card uk-card-default uk-margin-medium-top uk-margin-right uk-margin-left">
  <div class="uk-card-header container-top">
    <div class="uk-grid-small uk-flex-middle" uk-grid>
    <h4 class="norwester font-white">Events</h4>
    </div>
  </div>

  <div class="uk-card-body white">
    <div class="uk-grid-match uk-flex-top" uk-grid>
      <div  class="uk-width-1-2@m">
        <div id='calendar' class="uk-padding-small link-dk uk-height-small"></div>
        <!-- FullCalendar API and Scripts -->
        <link href='/fullcalendar/packages/core/main.css' rel='stylesheet' />
        <script src='/fullcalendar/packages/core/main.js'></script>
        <script src='/fullcalendar/packages/interaction/main.min.js'></script>
        <script src='/fullcalendar/packages/moment/main.min.js'></script>
        <link href='/fullcalendar/packages/list/main.css' rel='stylesheet' />
        <script src='/fullcalendar/packages/list/main.js'></script>
        <script src='/fullcalendar/packages/rrule/main.min.js'></script>
        <script src='/fullcalendar/vendor/rrule.js'></script>
        <link href='/fullcalendar/packages/daygrid/main.css' rel='stylesheet' />
        <script src='/fullcalendar/packages/daygrid/main.js'></script>
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            $.ajax({
              url: '/api/events',
              type: 'GET',
              data: {
                date: new Date()
              },
              success: function(data) {
                if (data) {
                  if (!Array.isArray(data)) {
                    data = [data];
                  }
                } else {
                  data = []
                }
                
                var calendar = new FullCalendar.Calendar(calendarEl, {
                  plugins: [ 'dayGrid', 'moment', 'list', 'interaction', 'rrule' ],
                  timeZone: 'local',
                  defaultView: 'listMonth',
                  defaultDate: new Date(),
                  header: {
                    left: 'title',
                    right: 'prev,next',
                  },
                  customButtons: {
                    addEventButton: {
                      text: 'Add',
                      click: function() {
                        var dateStr = prompt('Enter a date in YYYY-MM-DD format');
                        var date = new Date(dateStr + 'T00:00:00'); // will be in local time

                        if (!isNaN(date.valueOf())) { // valid?
                          calendar.addEvent({
                            title: 'dynamic event',
                            start: date,
                            allDay: true
                          });
                          alert('Great. Now, update your database...');
                        } else {
                          alert('Invalid date.');
                        }
                      }
                    }
                  },
                  events: data,
                  eventClick: function(info) {
                    info.jsEvent.preventDefault();
                    if (info.event.id) {
                      window.location.href = '/event-details?event_id=' + info.event.id;
                    }
                  }
                });

                calendar.render();
              },
              error: function() {
                alert('there was an issue loading the events calendar. Please refresh the page and try again.');
              }
            });
          });
        </script>
      </div>

      <% if (user.id === profileUser.id) { %>
      <div class="uk-width-1-2@m">
        <span class="profile-label">Announcements</span>
        <div v-if="announcements.length == 0">
          <i>No announcements to display.</i>
        </div>
        <div class="uk-divider-vertical uk-padding-small uk-padding-remove-top" v-for="announcement in announcements">
          <h6><span id="announcement_title">{{ announcement.headline }}</span><br>
          <span class="font-med" id="announcement_details">{{ announcement.content }}</span><br>
          <a class="line" href="">Learn More</a></h6>
        </div>
      </div>
      <% } %>
    </div>
  </div>
</div>


<!--------------------------->
<!-- Your Memories Section -->
<!--------------------------->
<div class="uk-card uk-card-default uk-margin uk-margin-right uk-margin-left">
  <div class="uk-card-header container-top">
      <div class="uk-grid-small uk-flex-middle" uk-grid>
        <h4 class="norwester font-white">Shared Memories</h4>
      </div>
  </div>
  <div class="uk-card-body white">
    <div class="uk-clearfix">
      <% if (user.id === profileUser.id) { %>
      <h5 class="uk-float-left">Share your special moments with fellow alumni. </br>All photos will appear on the communal 'Memories' page.</h5>
      <% } %>
      <a class="uk-float-right" href="/memories">Memories &nbsp;<i class="fa fa-external-link"></i></a>
    </div>

    <% if (profileUser.membership && profileUser.membership.membership_type !== 1) { %>
    <div class="uk-grid-match uk-child-width-1-4@m uk-flex-middle" uk-grid="masonry: true">
      <div>
        <div class="uk-padding">
          <% if (memories.length > 0) { %> 
            <% for (var idx = 0; idx < memories.length; idx++) { %>
              <span>
                <img class="uk-height-small uk-width-auto" src="/api/photo/<%= memories[idx].photo_ref %>" />
              </span>
            <% } %> 
            <img class="uk-height-small uk-width-auto" src="assets/image-file-add.png" /><br />
            <span><a class="font-black" href="#image-modal" uk-toggle><i class="fa fa-plus"></i>&nbsp; Add a Photo</a></span>
          <% } else { %>
            <img class="uk-height-small uk-width-auto" src="assets/image-file-add.png" /><br />
            <a class="font-black" href="#image-modal" uk-toggle><i class="fa fa-plus"></i>&nbsp; Your First Photo</a>
          <% } %>
          
          <!-- Here is the code for the add an image modal -->
          <div id="image-modal" uk-modal>
            <div class="uk-modal-dialog uk-modal-body fog">
              <button class="uk-modal-close-default" type="button" uk-close></button>
                <h2 class="uk-modal-title">Add a Memory</h2>
                <form>
                  <div class="uk-margin">
                      <div uk-form-custom>
                          <input id="new-memory-file" type="file">
                          <button class="uk-button button-lt" type="button" tabindex="-1"><span uk-icon="plus-circle"></span> &nbsp;Image</button>
                      </div>
                  </div>
                  <div class="uk-margin">
                    <span class="profile-label">*Memory Description</span>
                    <textarea class="uk-textarea" rows="5" placeholder="Enter an event description" v-model="newMemoryDescription"></textarea>
                  </div>
                </form>

                <p class="uk-text-left">
                    <button class="uk-button button-dk" type="button" v-on:click="saveMemory">Save</button>
                    <button class="uk-button button-lt uk-modal-close" type="button">Cancel</button>
                </p>
            </div>
          </div>
          </div>

        </div>
      </div>
    </div>
    <% } else if (user.id === profileUser.id) { %>
      <p>To contribute to the Memories page, please upgrade your <a href="/membership-types">membership plan</a>.</p>
    <% } else { %>
      <i><%= [profileUser.first_name, profileUser.middle_name, profileUser.last_name].filter(function(e) { return !!e; }).join(' ') %> has not yet shared any memories.</i>
    <% } %>
</div>
</div>

<!-- Change Password Modal -->
<div id="pw-modal" uk-modal>
    <div class="uk-modal-dialog uk-modal-body fog">
      <button class="uk-modal-close-default" type="button" uk-close></button>
        <h2 class="uk-modal-title">Change Your Password</h2>
        <form>
          <div class="uk-margin">
            <span class="profile-label">Current Password</span><br>
            <div class="uk-inline">
                <span class="uk-form-icon" uk-icon="icon: lock"></span>
                <input id="current-password-field" class="uk-input" placeholder="Current Password" type="password">
            </div>
        </div>
          <div class="uk-margin boundary">
            <span class="profile-label">New Password</span><br>
            <div class="uk-inline">
                <span class="uk-form-icon" uk-icon="icon: lock"></span>
                <input id="new-password-field" class="uk-input" placeholder="New Password" type="password">
                <div uk-drop="mode: click; pos: top-justify; boundary: .boundary; boundary-align: true">
            <div class="uk-card uk-card-body uk-card-secondary charcoal uk-padding-small">•	Minimum of 8 Characters<br>
      •	Must contain 1+ special characters<br>•	Must contain 1+ numbers<br>•	Must contain 1+ capital letters</h5></div>
        </div>
            </div>
        </div>
        <div class="uk-margin">
          <span class="profile-label">Confirm New Password</span><br>
          <div class="uk-inline">
              <span class="uk-form-icon" uk-icon="icon: lock"></span>
              <input id="confirm-password-field" class="uk-input" placeholder="Confirm Password" type="password">
          </div>
      </div>
        </form>

        <p class="uk-text-left">
            <button class="uk-button button-dk" type="button" v-on:click="changePassword">Save</button>
            <button class="uk-button button-lt uk-modal-close" type="button">Cancel</button>
        </p>
    </div>
</div>
</div>

<div id="activities-modal" class="uk-modal uk-close" uk-modal>
  <div class="uk-modal-dialog">
    <button class="uk-modal-close-default" type="button" uk-close></button>
    <div class="uk-modal-header fog">
      <h2 class="uk-modal-title">Add Activities</h2>
    </div>

    <div class="uk-modal-body" uk-overflow-auto>
      <h6>Select one or more activities from the list below to add them to the user.</h6>

      <div class="uk-card-body white border-charcoal uk-padding-remove uk-margin-remove">
        <div class="charcoal border-charcoal2 uk-padding-small uk-width-1-1">
          <div class="uk-form-controls uk-inline uk-margin-right uk-margin-bottom-small">
            <span class="uk-form-icon" uk-icon="icon: search"></span>
            <input class="uk-input border-charcoal2" type="text" placeholder="Search Activities" v-model="searchQuery">
          </div>
        </div>
        <table class="uk-table uk-table-small uk-margin-remove">
          <tbody>
            <tr v-for="activity in activities">
              <td><input :key="activity.id" class="uk-checkbox uk-margin-right" type="checkbox" :checked="currentUser.activities.some(function(e) { return e.id === activity.id; })" v-on:click="addActivity(event, activity)">{{ activity.name }}</td>
            </tr>
          </tbody>
        </table>
        <div class="uk-padding-small black">
          <ul class="uk-pagination uk-flex-center uk-margin-remove">
            <li><a v-on:click="paginateLeft"><span uk-icon="icon: chevron-left; ratio: 2" class="font-white"></span></a></li>
            <li>
              <div>
                <select class="uk-select border-charcoal2" v-model.number="pageNumber">
                  <option v-for="page in Array(pageCount).keys()">{{ page + 1 }}</option>
                </select>
              </div>
            </li>
            <li class="font-white uk-margin-small">of {{ pageCount }}</li>
            <li><a v-on:click="paginateRight"><span uk-icon="icon: chevron-right; ratio: 2" class="font-white"></span></a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="uk-modal-footer fog uk-text-left">
      <button class="uk-button button-dk" type="button" v-on:click="saveActivities">Save</button>
      <button class="uk-button button-lt uk-modal-close" type="button">Cancel</button>
    </div>
  </div>
</div>

<div class="uk-margin-large"></div>
<%- include('footer'); %>

<script type="text/javascript">
  var activitiesModal = new Vue({
    el: '#activities-modal',
    data: {
      currentUser: <%- JSON.stringify(profileUser) %>,
      activities: [],
      activityCount: 0,
      pageNumber: 1,
      pageSize: 10,
      searchQuery: '',
      selectedActivities: []
    },
    created: function() {
      this.selectedActivities = this.currentUser.activities.slice();
      this.refreshResults();
    },
    watch: {
      pageNumber: function() {
        this.refreshResults();
      },
      searchQuery: function() {
        this.pageNumber == 1 ?
          this.refreshResults() :
          this.pageNumber = 1;
      }
    },
    computed: {
      pageCount: function() {
        return Math.ceil(this.activityCount / this.pageSize);
      }
    },
    methods: {
      refreshResults: function() {
        var self = this;
        var queryString = '/api/activities-paginated?';
        queryString += 'page=' + this.pageNumber;
        queryString += '&pageSize=' + this.pageSize;
        queryString += '&sortAlphabetical=true';
        if (this.searchQuery) queryString += '&activityName=' + this.searchQuery;

        axios.get(queryString)
          .then(function(data) {
            if (data.data) {
              self.activities = data.data.activities;
              self.activityCount = data.data.count;
            }
          })
          .catch(function(err) {
            alert('There was an issue loading the activities list. Please try again');
          });
      },
      paginateLeft: function() {
        if (this.pageNumber > 1) this.pageNumber--;
      },
      paginateRight: function() {
        if (this.pageNumber < this.pageCount) this.pageNumber++;
      },
      addActivity: function(event, activity) {
        this.selectedActivities.some(function(e) {
          return e.id === activity.id;
        }) ? 
            this.selectedActivities.splice(this.selectedActivities.findIndex(function(el) { return el.id == activity.id; }), 1) :
            this.selectedActivities.push(activity);
      },
      saveActivities: function() {
        axios.post('/api/batch-join-activity', {
          activities: this.selectedActivities
        })
          .then(function(data) {
            alert('Successfully edited activities');
            UIkit.modal('#activities-modal').hide();
          })
          .catch(function(err) {
            alert('There was an issue processing your request. Please try again');
          })
      }
    }
  });

  var app = new Vue({
    el: '#app',
    data: {
      memories: <%- JSON.stringify(memories) %>,
      announcements: <%- JSON.stringify(announcements) %>,
      newMemoryDescription: ''
    },
    methods: {
      saveMemory: function() {
        var formData = new FormData();
        formData.append('memoryImage', $('#new-memory-file')[0].files[0]);
        formData.append('memoryDescription', this.newMemoryDescription);

        axios.post('/api/memory', formData, {
          headers: {
            'Content-Type': 'multipart/form-data'
          }
        }).then(function(res) {
          var modal = UIkit.modal('#image-modal').hide();
        }).catch(function(err) {
          alert('There was an issue saving your memory. Please refresh the page and try again.');
        });
      },
      signOut: function() {
        axios.get('/api/logout')
          .then(function(data) {
            if (data.redirect) {
              window.location.href = data.redirect;
            } else {
              window.location.href = '/sign-in';
            }
          })
          .catch(function(err) {
            
          });
      },
      changePassword: function() {
        if (!$('#new-password-field').val().match(/^(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\$%\^&\*])(?=.{8,})/)) {
          alert('New password does not satisfy the security requirements.');
        } else if ($('#new-password-field').val() != $('#confirm-password-field').val()) {
          alert('Warning: passwords do not match');
        } else {
          axios.post('/api/change-password', {
            currentPassword: $('#current-password-field').val(),
            newPassword: $('#new-password-field').val()
          })
          .then(function(data) {
            $('#current-password-field').val('');
            $('#new-password-field').val('');
            $('#confirm-password-field').val('');
            UIkit.modal('#pw-modal').hide();
          })
          .catch(function(err) {
            alert('There was an error changing your password. Please try again');
          });
        }
      }
    }
  });
</script>
</body>
</html>
